# ğŸš€ Guia Passo a Passo - Pipeline CI/CD Completo

Este guia te levarÃ¡ do zero atÃ© ter um pipeline CI/CD completo funcionando com Jenkins, SAST, DAST, Kubernetes e ArgoCD.

## ğŸ“‹ PrÃ©-requisitos

### 1. **Ferramentas NecessÃ¡rias**
```bash
# Verificar se estÃ£o instaladas
docker --version          # Docker 20.10+
kubectl version --client  # kubectl 1.24+
git --version             # Git 2.x+
```

### 2. **Acessos NecessÃ¡rios**
- [ ] Cluster Kubernetes funcionando
- [ ] Docker Registry (Docker Hub, Google Container Registry, etc.)
- [ ] GitHub repository: `git@github.com:periclesandrade21/jenkins_nodejs.git`
- [ ] DomÃ­nios para as aplicaÃ§Ãµes (ou usar nip.io para testes)

---

## ğŸ”§ FASE 1: PreparaÃ§Ã£o do Ambiente

### Passo 1.1: Clonar e Configurar RepositÃ³rio
```bash
# Clonar seu repositÃ³rio
git clone git@github.com:periclesandrade21/jenkins_nodejs.git
cd jenkins_nodejs

# Copiar arquivos da infraestrutura (do ambiente atual)
# VocÃª precisa copiar todos os arquivos que foram criados para seu repositÃ³rio
```

### Passo 1.2: Verificar DependÃªncias
```bash
# Usar o comando make para verificar
make check-deps
```

### Passo 1.3: Configurar PermissÃµes
```bash
# Dar permissÃ£o aos scripts
chmod +x scripts/*.sh
```

---

## âš™ï¸ FASE 2: ConfiguraÃ§Ã£o de Credenciais

### Passo 2.1: Configurar Jenkins
```bash
# Copiar arquivo de exemplo
cp jenkins/.env.example jenkins/.env

# Editar com suas credenciais
nano jenkins/.env
```

**Configurar as seguintes variÃ¡veis em `jenkins/.env`:**
```bash
# Jenkins
JENKINS_ADMIN_PASSWORD=SuaSenhaSegura123

# Docker Registry (exemplo Docker Hub)
DOCKER_REGISTRY=docker.io/seuusuario
DOCKER_REGISTRY_USER=seuusuario
DOCKER_REGISTRY_PASSWORD=suasenhadockerhub

# Git (Token do GitHub)
GIT_USERNAME=periclesandrade21
GIT_TOKEN=ghp_seu_token_aqui

# SonarQube (serÃ¡ gerado depois)
SONARQUBE_TOKEN=deixe_vazio_por_enquanto

# Kubernetes (serÃ¡ configurado depois)
KUBECONFIG_B64=deixe_vazio_por_enquanto
```

### Passo 2.2: Atualizar DomÃ­nios
**OpÃ§Ã£o A: Usar seus domÃ­nios reais**
```bash
# Substituir yourdomain.com pelos seus domÃ­nios
find . -name "*.yaml" -exec sed -i 's/yourdomain.com/seudominio.com/g' {} \\;
```

**OpÃ§Ã£o B: Usar nip.io para testes (mais fÃ¡cil)**
```bash
# Obter IP do seu cluster
CLUSTER_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
echo "IP do cluster: $CLUSTER_IP"

# Atualizar com nip.io
find . -name "*.yaml" -exec sed -i "s/yourdomain.com/${CLUSTER_IP}.nip.io/g" {} \\;
```

### Passo 2.3: Configurar Registry
```bash
# Substituir your-registry.com pelo seu registry
find . -name "*.yaml" -name "Jenkinsfile" -exec sed -i 's/your-registry.com/docker.io\\/seuusuario/g' {} \\;
```

---

## ğŸ—ï¸ FASE 3: Setup da Infraestrutura

### Passo 3.1: Configurar Cluster Kubernetes
```bash
# Verificar conexÃ£o com cluster
kubectl cluster-info

# Executar setup completo
make setup
```

**O script vai instalar:**
- NGINX Ingress Controller
- cert-manager (para HTTPS)
- ArgoCD
- Namespaces (app-dev, app-hml)
- Aplicar todos os manifestos

### Passo 3.2: Obter InformaÃ§Ãµes Importantes
```bash
# Senha do ArgoCD
make argocd-password

# Status dos pods
kubectl get pods -A
```

---

## ğŸš€ FASE 4: Configurar Jenkins

### Passo 4.1: Iniciar Jenkins
```bash
# Iniciar containers do Jenkins
make setup-jenkins

# Verificar se estÃ¡ rodando
docker-compose -f jenkins/docker-compose.jenkins.yml ps
```

### Passo 4.2: Acessar Jenkins
```bash
# Jenkins estarÃ¡ disponÃ­vel em:
# http://localhost:8080
# User: admin
# Password: (definida no .env)
```

### Passo 4.3: Configurar SonarQube
```bash
# SonarQube estarÃ¡ em:
# http://localhost:9000
# User: admin
# Password: admin (altere na primeira vez)

# ApÃ³s login no SonarQube:
# 1. Ir em Administration > Security > Users
# 2. Gerar token para admin
# 3. Copiar o token e atualizar jenkins/.env
echo "SONARQUBE_TOKEN=seu_token_aqui" >> jenkins/.env

# Reiniciar Jenkins para carregar nova variÃ¡vel
docker-compose -f jenkins/docker-compose.jenkins.yml restart jenkins
```

### Passo 4.4: Configurar Kubeconfig no Jenkins
```bash
# Gerar kubeconfig em base64
cat ~/.kube/config | base64 -w 0 > kubeconfig.b64

# Adicionar ao .env
echo "KUBECONFIG_B64=$(cat kubeconfig.b64)" >> jenkins/.env

# Reiniciar Jenkins
docker-compose -f jenkins/docker-compose.jenkins.yml restart jenkins
```

---

## ğŸ”’ FASE 5: Testar SeguranÃ§a

### Passo 5.1: Executar Testes Locais
```bash
# Testes bÃ¡sicos de seguranÃ§a
make security

# Testes completos (demora mais)
make security-full
```

### Passo 5.2: Verificar RelatÃ³rios
```bash
# Ver relatÃ³rios gerados
ls -la security-reports/
cat security-reports/security-summary.md
```

---

## ğŸš¢ FASE 6: Deploy e Testes

### Passo 6.1: Build e Deploy Local
```bash
# Build das imagens
make build

# Push para registry
make push

# Deploy para desenvolvimento
make deploy-dev
```

### Passo 6.2: Verificar Deploy
```bash
# Status dos pods
make status

# Logs da aplicaÃ§Ã£o
make logs

# Testar aplicaÃ§Ã£o
curl https://app-dev.${CLUSTER_IP}.nip.io/api/
```

### Passo 6.3: Deploy para HomologaÃ§Ã£o
```bash
# Deploy para homologaÃ§Ã£o
make deploy-hml

# Verificar
kubectl get pods -n app-hml
```

---

## ğŸ”„ FASE 7: Configurar Pipeline AutomÃ¡tico

### Passo 7.1: Fazer Commit das ConfiguraÃ§Ãµes
```bash
# Adicionar arquivos ao git
git add .
git commit -m "feat: pipeline CI/CD completo configurado"
git push origin main
```

### Passo 7.2: Verificar Jenkins Pipeline
1. Acessar Jenkins: http://localhost:8080
2. O job `fastapi-react-app` deve aparecer automaticamente
3. Verificar se o pipeline estÃ¡ rodando

### Passo 7.3: Testar Pipeline Completo
```bash
# Criar branch de desenvolvimento
git checkout -b develop
echo "# Teste" >> README.md
git add README.md
git commit -m "test: pipeline automation"
git push origin develop
```

**O pipeline deve:**
1. Fazer checkout do cÃ³digo
2. Instalar dependÃªncias
3. Executar testes
4. Executar SAST/DAST
5. Build das imagens
6. Deploy para dev

---

## ğŸ“Š FASE 8: Verificar ArgoCD

### Passo 8.1: Acessar ArgoCD
```bash
# Port-forward se necessÃ¡rio
make argocd-port-forward

# Ou acesse diretamente (se configurou domÃ­nio)
# https://argocd.seudominio.com
```

### Passo 8.2: Verificar AplicaÃ§Ãµes
- Login: admin
- Senha: (obtida com `make argocd-password`)
- Verificar aplicaÃ§Ãµes `fastapi-react-app-dev` e `fastapi-react-app-hml`

---

## ğŸ¯ FASE 9: Monitoramento (Opcional)

### Passo 9.1: Instalar Stack de Monitoramento
```bash
# Instalar Prometheus + Grafana
make monitoring
```

### Passo 9.2: Acessar Dashboards
```bash
# Port-forward do Grafana
kubectl port-forward -n monitoring svc/monitoring-grafana 3000:80

# Acesse: http://localhost:3000
# User: admin / Password: admin123
```

---

## âœ… FASE 10: ValidaÃ§Ã£o Final

### Passo 10.1: Checklist de ValidaÃ§Ã£o
```bash
# 1. Verificar todos os pods estÃ£o rodando
kubectl get pods -A

# 2. Testar aplicaÃ§Ãµes
curl https://app-dev.${CLUSTER_IP}.nip.io/
curl https://app-hml.${CLUSTER_IP}.nip.io/

# 3. Verificar Jenkins
curl http://localhost:8080

# 4. Verificar ArgoCD
curl https://argocd.${CLUSTER_IP}.nip.io

# 5. Executar testes completos
make test
```

### Passo 10.2: Teste de Pipeline End-to-End
```bash
# 1. Fazer mudanÃ§a no cÃ³digo
echo "console.log('Pipeline test');" >> frontend/src/App.js

# 2. Commit e push
git add .
git commit -m "test: pipeline end-to-end"
git push origin develop

# 3. Acompanhar pipeline no Jenkins
# 4. Verificar deploy automÃ¡tico no ArgoCD
# 5. Validar aplicaÃ§Ã£o funcionando
```

---

## ğŸ› ï¸ Comandos Ãšteis para o Dia a Dia

### Desenvolvimento
```bash
make help                 # Ver todos os comandos
make build               # Build das imagens
make test                # Executar testes
make deploy-dev          # Deploy para dev
make logs                # Ver logs
make status              # Status dos recursos
```

### SeguranÃ§a
```bash
make security            # Testes de seguranÃ§a bÃ¡sicos
make security-full       # Testes completos
make lint                # Linting do cÃ³digo
```

### Troubleshooting
```bash
make jenkins-logs        # Logs do Jenkins
make sonar-logs          # Logs do SonarQube
kubectl describe pod POD_NAME -n NAMESPACE  # Debug de pods
```

### Limpeza
```bash
make clean              # Limpar recursos locais
make clean-dev          # Limpar ambiente dev
make clean-hml          # Limpar ambiente hml
make clean-all          # CUIDADO: Limpa tudo!
```

---

## ğŸš¨ Troubleshooting Comum

### Problema 1: Jenkins nÃ£o inicia
```bash
# Verificar logs
make jenkins-logs

# Verificar permissÃµes Docker
sudo usermod -aG docker $USER
newgrp docker
```

### Problema 2: Pods nÃ£o iniciam no Kubernetes
```bash
# Ver eventos
kubectl get events --sort-by=.metadata.creationTimestamp

# Verificar recursos
kubectl describe pod POD_NAME -n NAMESPACE
```

### Problema 3: ArgoCD nÃ£o sincroniza
```bash
# Verificar aplicaÃ§Ãµes
kubectl get applications -n argocd

# ForÃ§ar sync
kubectl patch application fastapi-react-app-dev -n argocd --type merge -p '{"spec":{"syncPolicy":{"automated":{"prune":true,"selfHeal":true}}}}'
```

### Problema 4: Registry nÃ£o permite push
```bash
# Login no Docker
docker login -u seuusuario

# Verificar credenciais no Jenkins
# Ir em Jenkins > Credentials > System > Global credentials
```

---

## ğŸ“ PrÃ³ximos Passos

ApÃ³s seguir todos os passos, vocÃª terÃ¡:

âœ… **Jenkins** rodando com pipeline completo  
âœ… **Kubernetes** com aplicaÃ§Ãµes em dev/hml  
âœ… **ArgoCD** gerenciando GitOps  
âœ… **SAST/DAST** integrados no pipeline  
âœ… **Monitoramento** (se instalado)  
âœ… **AutomaÃ§Ã£o** completa via Makefile  

### Para ProduÃ§Ã£o:
1. Configurar domÃ­nios reais com DNS
2. Configurar certificados SSL vÃ¡lidos
3. Configurar backup do Jenkins
4. Implementar disaster recovery
5. Configurar alertas no monitoramento
6. Review de seguranÃ§a completo

**ğŸ‰ Seu pipeline CI/CD estÃ¡ funcionando!**
